<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Heebo&display=swap" rel="stylesheet">
</head>
<body>
    <center>
    <nav>
        <button id="statsNavBtn" class="navBtn" onclick="showScreen('statsScreen')">נתונים</button>
        <button id="configNavBtn" class="navBtn" onclick="showScreen('configScreen')">הגדר</button>
    </nav>
    <!--SCREENS-->

    <!--stats screen-->
    <div class="screen" id="statsScreen">
        <h1>📈 נתונים 📊</h1>
        <div class="panel">
            <h3>🪙 יתרה כעת</h3>
            <span id="currentBalance">loading</span>
        </div>
        
        <div class="panel">
            <h3>💵 תחזית היתרה לפי חודש</h3>
            <canvas id="balancePredictionChart" style="height: 300px; width: 100%;"></canvas>
        </div>

        <div class="panel">
            <h3>💰 תחזית שווי החסכונות לפי חודש</h3>
            <canvas id="savingsPredictionChart" style="height: 300px; width: 100%;"></canvas>
        </div>

        <div class="panel">
            <h3>💸 תחזית שווי כלל הנכסים לפי חודש</h3>
            <canvas id="totalAssetsChart" style="height: 300px; width: 100%;"></canvas>
        </div>
    </div>
    
    <!--config screen-->
    <div class="screenHidden" id="configScreen">
        <!--Osh Movement-->
        <h1>✏️ הגדר פרטים ⚙️</h1>
        <div id="oshes" class="panel">loading</div>

        <div class="panel">
            <h3>💵 הוסף שינוי עו"ש חודשי</h3>
            <input id="oshNameInput" placeholder="שם השינוי בעוש"/><input id="oshValueInput" placeholder="כמה השינוי" type="number"/>
            <button onclick="addOshClick()">הוסף</button>
        </div>

        <!--Savings-->
        <div id="savings" class="panel">loading</div>

        <div class="panel">
            <h3>💰 הוסף חיסכון</h3>
            <input id="savingNameInput" placeholder="שם החיסכון"/><input id="savingValueInput" placeholder="שווי כעת" type="number"/><input id="savingChangeInput" placeholder="אחוז גדילה שנתי" type="number"/>
            <button onclick="addSavingClick()">הוסף</button>
        </div>

        <!--Set current balance-->
        <div class="panel">
            <h3>🪙 הגדר יתרה כעת</h3>
            <input id="balanceValueInput" placeholder="יתרה כעת" type="number"/>
            <button onclick="setBalanceClick()">הגדר</button>
        </div>
    </div>
    </center>
</body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.js"></script>
<script>
    const currencySign = '₪';
    const screensId = ['statsScreen', 'configScreen']; // app screens id's
    const navButtonsId = ['statsNavBtn', 'configNavBtn'] // nav buttons id's in the same order as the screen id's
    let osh = []; // list of oshObjects
    let savings = []; // list of savingObjects
    let currectBalance = 0; // the spendable money user have

    showScreen(screensId[0]);

    // init panel charts

    // balance chart
    const balanceChart = createChart('balancePredictionChart', 'יתרה לפי חודש' + ' (' + currencySign + ')');

    // savings chart
    const savingsChart = createChart('savingsPredictionChart', 'ערך החסכונות לפי חודש' + ' (' + currencySign + ')');

    // total assets chart
    const totalAssetsChart = createChart('totalAssetsChart', 'שווי כולל של נכסים' + ' (' + currencySign + ')');

    function createChart(canvasId, title)
    {
        const data = {
            labels: [],
            datasets: [{
                label: title,
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        const conf = {
            type: 'line',
            data: data,
            options: {
                responsive: false,
                maintainAspectRatio: false,
            }
        };
        const ctx = document.getElementById(canvasId).getContext('2d');
        const chart = new Chart(ctx, conf);

        return chart;
    }

    function addData(chart, label, data) {
        chart.data.labels.push(label);
        chart.data.datasets.forEach((dataset) => {
            dataset.data.push(data);
        });
        chart.update();
    }

    function removeData(chart) {
        chart.data.labels.pop();
        chart.data.datasets.forEach((dataset) => {
            dataset.data.pop();
        });
        chart.update();
    }

    function arrayCompare(arr, secArr)
    {
        if (arr.length != secArr.length)
        {
            return false;
        }
        else
        {
            for (let i = 0; i < arr.length; i++)
            {
                if (arr[i] != secArr[i])
                {
                    return false;
                }
            }
        }

        return true;
    }

    function getBalancePredictionForMonth(numOfMonths, monthTotalEraning)
    {
        let balanceOverTheMonthes = [];
        for (let i = 0; i < numOfMonths; i++)
        {
            let res = currectBalance + (i * monthTotalEraning);
            balanceOverTheMonthes.push(res);
        }

        return balanceOverTheMonthes;
    }

    function getTotalSavingsValuePrediction(numOfMonths)
    {
        let result = [];
        for (let i = 0; i < numOfMonths; i++)
        {
            let res = 0;
            for (let j = 0; j < savings.length; j++)
            {
                let save = savings[j];
                res += save.value * (((save.change / (12 * 100)) + 1) ** i);
            }
            result.push(res);
        }

        return result;
    }

    function getTotalAssetsValueOverMonth(numOfMonths, monthTotalEraning)
    {
        let result = [];
        let savings = getTotalSavingsValuePrediction(numOfMonths);
        let balances = getBalancePredictionForMonth(numOfMonths, monthTotalEraning);
        for (let i = 0; i < numOfMonths; i++)
        {
            result.push(savings[i] + balances[i]);
        }

        return result;
    }

    function oshObject(name, value)
    {
        return {'id': Math.random().toString(), 'name': name, 'value': value};
    }

    function addOsh(name, value)
    {
        let obj = oshObject(name, value);
        osh.push(obj);
    }

    function removeOsh(oshId)
    {
        let index = -1;
        for (let i in osh)
        {
            let oshObj = osh[i];
            if (oshObj.id == oshId)
            {
                index = i;
            }
        }

        if (index >= 0)
        {
            osh.splice(index, 1);
        }
    }

    function savingObject(name, value, change)
    {
        return {'id': Math.random().toString(), 'name': name, 'value': value, 'change': change};
    }
    
    function addSaving(name, value, change)
    {
        let obj = savingObject(name, value, change);
        savings.push(obj);
    }
    
    function removeSaving(saveId)
    {
        let index = -1;
        for (let i in savings)
        {
            let obj = savings[i];
            if (obj.id == saveId)
            {
                index = i;
            }
        }

        if (index >= 0)
        {
            savings.splice(index, 1);
        }
    }
    
    function setBalanceClick()
    {
        const balanceValueInput = document.getElementById('balanceValueInput');
        currectBalance = parseFloat(balanceValueInput.value);
        balanceValueInput.value = '';
        update();
    }
    
    // prevs and elements - before update
    const oshes = document.getElementById('oshes');
    let prevOshes = oshes.innerHTML;
    const savingsCont = document.getElementById('savings');
    let prevSavings = savingsCont.innerHTML;
    let prevBalacePredictionData = [];
    let prevSavingsOverTheMonthes = [];
    let prevAssetsOverMonth = [];
    
    function update()
    {
        // total earinings
        let monthTotalEraning = 0;
        for (let i in osh)
        {
            let oshObj = osh[i];
            monthTotalEraning += oshObj.value;
        }

        // total savings
        let totalSavings = 0;
        for (let i in savings)
        {
            let obj = savings[i];
            totalSavings += obj.value;
        }

        // oshes
        let res = '<h3>💵 שינויים חודשיים בעו"ש:</h3>';
        for (let i in osh)
        {
            let oshObj = osh[i];
            res += oshObj.name + ': ' + oshObj.value.toString() + currencySign + ' ' + '<button onclick="removeOsh(' + "'" + oshObj.id + "'" + ')">מחק</button><br>';
        }
        res += osh.length == 0 ? 'אין לך שינויים. הוסף!' : ''; // show text if there are no entries

        res += "<br><h3>רווח חודשי: " + monthTotalEraning.toString() + currencySign + "</h3>";

        if (prevOshes != res)
        {
            oshes.innerHTML = res;
            prevOshes = oshes.innerHTML;
        }

        // savings
        res = '<h3>💰 חסכונות:</h3>';
        for (let i in savings)
        {
            let obj = savings[i];
            res += obj.name + ': ' + obj.value.toString() + currencySign + ' ' + obj.change.toString() + '% שינוי שנתי ' + '<button onclick="removeSaving(' + "'" + obj.id + "'" + ')">מחק</button><br>';
        }
        res += savings.length == 0 ? 'אין לך חסכונות. הוסף!' : ''; // show text if there are no entries

        res += "<br><h3>סך הכל בחסכונות: " + totalSavings.toString() + currencySign + "</h3>";

        if (prevSavings != res)
        {
            savingsCont.innerHTML = res;
            prevSavings = savingsCont.innerHTML;
        }


        // stats panels
        document.getElementById('currentBalance').innerHTML = currectBalance + currencySign;

        // charts

        // balance chart
        const numOfMonths = 7;
        let balanceOverTheMonthes = getBalancePredictionForMonth(numOfMonths, monthTotalEraning);
        if (arrayCompare(balanceOverTheMonthes, prevBalacePredictionData) == false)
        {
            let labels = [];
            for (let i = 0; i < numOfMonths; i++)
            {
                let label = (i).toString() + ' חודשים';
                labels.push(label);
            }

            for (let i = 0; i < 10; i++)
                removeData(balanceChart);
            
            for (let i = 0; i < numOfMonths; i++)
            {
                addData(balanceChart, labels[i], balanceOverTheMonthes[i]);
            }
            //document.getElementById('balancePredictionChart').height = 200;

            prevBalacePredictionData = balanceOverTheMonthes;
        }

        //savingsChart
        let savingsOverTheMonthes = getTotalSavingsValuePrediction(numOfMonths);
        if (arrayCompare(savingsOverTheMonthes, prevSavingsOverTheMonthes) == false)
        {
            let labels = [];
            for (let i = 0; i < numOfMonths; i++)
            {
                let label = (i).toString() + ' חודשים';
                labels.push(label);
            }

            for (let i = 0; i < 10; i++)
                removeData(savingsChart);
            
            for (let i = 0; i < numOfMonths; i++)
            {
                addData(savingsChart, labels[i], savingsOverTheMonthes[i]);
            }

            prevSavingsOverTheMonthes = savingsOverTheMonthes;
        }

        // total assets value chart
        let assetsOverMonth = getTotalAssetsValueOverMonth(numOfMonths, monthTotalEraning);
        if (arrayCompare(assetsOverMonth, prevAssetsOverMonth) == false)
        {
            let labels = [];
            for (let i = 0; i < numOfMonths; i++)
            {
                let label = (i).toString() + ' חודשים';
                labels.push(label);
            }

            for (let i = 0; i < 10; i++)
                removeData(totalAssetsChart);
            
            for (let i = 0; i < numOfMonths; i++)
            {
                addData(totalAssetsChart, labels[i], assetsOverMonth[i]);
            }

            prevAssetsOverMonth = assetsOverMonth;
        }
    }
    
    function addOshClick()
    {
        const oshNameInput = document.getElementById('oshNameInput');
        const oshValueInput = document.getElementById('oshValueInput');
        let name = oshNameInput.value;
        let value = parseFloat(oshValueInput.value);
        addOsh(name, value);

        oshNameInput.value = '';
        oshValueInput.value = '';
        update();
    }

    function addSavingClick()
    {
        const savingNameInput = document.getElementById('savingNameInput');
        const savingValueInput = document.getElementById('savingValueInput');
        const savingChangeInput = document.getElementById('savingChangeInput');
        let name = savingNameInput.value;
        let value = parseFloat(savingValueInput.value);
        let change = parseFloat(savingChangeInput.value);
        addSaving(name, value, change);

        savingNameInput.value = '';
        savingValueInput.value = '';
        savingChangeInput.value = '';

        update();
    }

    function showScreen(screenId)
    {
        // show the screen
        for (let i in screensId)
        {
            document.getElementById(screensId[i])/*.style.display = 'none'*/.className = 'screenHidden';
        }
        document.getElementById(screenId)/*.style.display = 'block'*/.className = 'screen';


        let index = screensId.indexOf(screenId);

        // set nav buttons classes
        for (let i in navButtonsId)
        {
            document.getElementById(navButtonsId[i]).className = 'navBtn';
        }
        document.getElementById(navButtonsId[index]).className = 'navBtnClicked';
    }

    setInterval(update, 10); // update UI
</script>
<style>
    :root {
        --font-family: 'Heebo', sans-serif;
    }

    body {
        text-align: center;
        direction: rtl;
        margin: 0;
        margin-bottom: 100px;
        font-family: var(--font-family);
    }

    .screen {
        display: block;
    }

    .screenHidden {
        display: none;
    }

    nav {
        /*padding: 10px 0px;*/
        background-color: DarkSeaGreen;
        position: fixed;
        bottom: 0;
        width: 100%;
        box-shadow: 0px -8px 34px -11px rgba(0,0,0,0.75);
    }

    .panel {
        padding: 20px;
        border-style: solid;
        border-width: 1px;
        border-color: lightgray;
        border-radius: 5px;
        margin: 20px;
    }

    button {
        padding: 10px;
        background-color: white;
        border-style: solid;
        border-width: 1px;
        border-color: black;
        box-shadow: 0px 0px 10px 0px rgba(0,0,0,0.25);
        margin: 10px;
        font-family: var(--font-family);
        border-radius: 10px;
        color: black;
    }

    input {
        padding: 10px;
        font-family: var(--font-family);
        width: 40%;
        outline: none;
    }

    .navBtn {
        margin: 0px;
        padding: 0px;
        border-radius: 0px;
        border-style: none;
        color: black;
        height: 70px;
        width: 49%;
        background: none;
        box-shadow: none;
    }

    .navBtnClicked {
        margin: 0px;
        padding: 0px;
        border-radius: 0px;
        border-style: none;
        color: black;
        height: 70px;
        width: 49%;
        background: none;
        box-shadow: none;
        font-weight: bolder;
    }
</style>
</html>